@**
 * Copyright (c) 2013, 2016 Kaj Magnus Lindberg
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 *@

@(tpi: debiki.SiteTpi, anySectionId: Option[String], searchPhrase: String,
  pagesAndHits: Seq[ed.server.search.PageAndHits])

@import com.debiki.core._
@import ed.server.search._


@foundWhere(hit: SearchHit) = @{
  hit.postNr match {
    case PageParts.TitleNr => "the title"
    case PageParts.BodyNr => "the page text"
    case _ => "a comment"
  }
}


@* Add later:   , by { hit.post.user_!.displayName }:</em>   *@

@searchResultsHtml = @{
  if (pagesAndHits.isEmpty) <p>Nothing found.</p>
  else <div>{
    var tabindex = 1 // this (1) starts on 2. (The search phrase field has id 1.)

    for (pageAndHits <- pagesAndHits) yield {
      val pageId = pageAndHits.pageId
      val pageTitle = pageAndHits.pageTitle
      tabindex += 1
      <h3 class="esSERP_Hit_PageTitle">
        <a href={s"/-$pageId"} tabindex={tabindex.toString}>{pageTitle}</a>
      </h3> ++
      (for (hit <- pageAndHits.hitsByScoreDesc) yield {
        tabindex += 1
        <span class="esSERP_Hit_In">In <a href={s"/-$pageId#post-${hit.postNr}"}
              class="esSERP_Hit_In_Where" tabindex={tabindex.toString}>{
          foundWhere(hit)
        }</a>:</span>
        <p class="esSERP_Hit_Text">{
          xml.Unparsed(hit.approvedTextWithHighligtsHtml mkString " <b>...</b> ")
        }</p>
      })
    }
  }</div>
}

@wrapper(tpi) {
  <!-- searchResults.scala.html -->
  <div class='container esSERP'>

  <div class="esLegal_home">@{/*
    href="/" will be wrong if coming from the forum and it's base path isn't /, but e.g.
    /forum/. Ignore this minor problem, for now. [7KUFS25] */}
    <a class="esLegal_home_link" href="/">Home</a><span class="esLegal_home_arw"> â†’</span>
  </div>

  <h1>Search Results</h1>

  <br>
  <br>
  @views.html.searchForm(tpi, oldSearchPhrase = Some(searchPhrase),
    sectionId = anySectionId, autofocus = true)

  <br>
  @searchResultsHtml
  </div>
}

